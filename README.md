# ORCS-terraform
![Terraform](https://img.shields.io/badge/Terraform-~%3E0.11.0-green.svg)

Provisions chewy's orc infrastructure.

## pre-requisites
__Install Terraform:__

Terraform >= 0.11.0 (https://www.terraform.io/) 

``` 
$ brew update
$ brew install terraform
```

__Configure AWS Credentials and Config__

Configure your IAM keys in __~/.aws/credentials__ :
```
[orc-platform]
aws_access_key_id=xxxxxxxxxxxxxxxxxxxx
aws_secret_access_key=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```
Configure your Config in __~/.aws/config__ :
```bash
[default]
region = us-east-1
[profile orc-platform]
region = us-east-1

```
## Initialize
```
$ terraform workspace new `whoami`
$ terraform init
```
All your AWS resources will be annotated with `whoami`-{env}
## Plan
The terraform plan command is used to create an execution plan. Terraform performs a refresh, unless explicitly disabled, and then determines what actions are necessary to achieve the desired state specified in the configuration files.

Note: ensure you are under a specific __./environment/{env}__ directory
```
$ terraform plan
```

## Apply
The terraform apply command is used to apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a terraform plan execution plan.

Note: ensure you are under a specific __./environment/{env}__ directory
```
$ terraform plan

  or ignore the prompt
  
$ terraform plan -auto-approve 
```

## Destroy Infrastructure
Note: ensure you are under a specific __./environment/{env}__ directory

```bash
$ terraform destroy

  or ignore the prompt
  
$ terraform destroy -auto-approve 

```
## Bastion Hosts
A bastion host will be deployed on every availability zone to ensure connectivity into the AWS resources
launched. The bastion host sits on the public network and has limited tools installed. It's sole purpose
is to server as a jump host and nothing more. Follow these guiding principles to keep the environment
secure:
* Never install anything thats not required
* Use ssh agent forwarding for propagating private keys
* Use ssh port forwarding for exposing ports locally to connect (i.e dbVisualizer etc.)


#### Visualizing Terraform Dependencies
It is possible to generate a graph from the terraform scripts. The format is not easily read by humans
but you can change that by using a graph visualization application (i.e : graphviz)
* Install graphviz
* Output DOT file from terraform
* Convert DOT file into a graphical image

```bash
For Macs: 

$ brew install graphviz
$ terraform graph > graph.dot
$ dot -Tsvg graph.dot -o graph.svg
```
Open the graph.svg for a nice graphical representation of what is actually happening inside terraform for
the script your attempting to run
